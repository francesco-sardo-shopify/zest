import{w as N}from"./with-props-C97DBiG3.js";import{j as e}from"./jsx-runtime-BjG_zV1W.js";import{p as C,q as E,r as a}from"./chunk-AYJ5UCUI-pMwHqBCg.js";import{e as L}from"./epub-B2xxWx9D.js";import{deleteBook as R,getBook as T,updateBook as B}from"./db-Dghpep6g.js";import{T as $}from"./TopBar-C2zSAFsJ.js";function V({params:u}){return[{title:"Reading - Zest"},{name:"description",content:"Read your book with Zest"}]}async function D({request:u,params:d}){const r=u.method,{bookId:l}=d;if(r==="DELETE")return await R(l),C(E("/"))}async function W({params:u}){const{bookId:d}=u,r=await T(d),l=await r.file.arrayBuffer();return{book:r,arrayBuffer:l}}const Z=N(function({loaderData:d}){const{book:r,arrayBuffer:l}=d,x=a.useRef(null),o=a.useRef(null),s=a.useRef(null),[k,m]=a.useState(!1),[w,v]=a.useState([]),b=t=>{t.preventDefault(),o.current&&(t.key==="ArrowRight"?o.current.next():t.key==="ArrowLeft"&&o.current.prev())};a.useEffect(()=>{if(!x.current)return;s.current=L(l),s.current.locations.load(r.locations.toString());const t=s.current.renderTo(x.current,{width:"100%",height:"100%",spread:"none"});o.current=t,(async()=>{await s.current.ready,r.location?t.display(r.location.start):t.display();try{const n=await s.current.loaded.navigation;if(n&&n.toc&&n.toc.length>0)v(n.toc);else{const f=s.current.spine.items.map((p,h)=>({href:p.href,label:`Section ${h+1}`,id:`spine-${h}`}));v(f)}}catch(n){console.error("Error loading table of contents:",n);const f=s.current.spine.items.map((p,h)=>({href:p.href,label:`Section ${h+1}`,id:`spine-${h}`}));v(f)}})();const c=async n=>{const{start:g,end:f,percentage:p}=n;await B({...r,location:{start:g,end:f,percentage:p}})};return t.on("locationChanged",c),document.addEventListener("keyup",b,!0),()=>{document.removeEventListener("keyup",b,!0),o.current&&o.current.off("locationChanged",c),s.current&&s.current.destroy()}},[l,r]),a.useEffect(()=>(document.addEventListener("keyup",b,!0),()=>{document.removeEventListener("keyup",b,!0)}),[]);const j=t=>{if(console.log(`Navigation clicked: ${t}`,!!o.current),!o.current){console.error("Rendition reference is not available");return}t==="next"?o.current.next():o.current.prev()},y=t=>{if(o.current)try{o.current.display(t),m(!1)}catch(i){console.error("Error navigating to section:",i)}};return e.jsxs("div",{className:"flex flex-col h-screen pt-14 relative",children:[e.jsx($,{currentPage:"reader",bookId:r.id,children:e.jsx("button",{onClick:()=>m(!k),className:"ml-auto p-2 text-white hover:text-blue-100 transition-colors","aria-label":"Toggle table of contents",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h7"})})})}),k&&e.jsxs("div",{className:"fixed inset-0 z-50 flex",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:()=>m(!1)}),e.jsxs("div",{className:"relative w-80 max-w-[80%] h-full bg-white shadow-lg overflow-auto z-10 ml-auto",children:[e.jsxs("div",{className:"sticky top-0 bg-white p-4 border-b flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Table of Contents"}),e.jsx("button",{onClick:()=>m(!1),className:"p-1 rounded-full hover:bg-gray-100",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("ul",{className:"p-4",children:w.length>0?w.map((t,i)=>e.jsxs("li",{className:"py-2 border-b last:border-b-0",children:[e.jsx("button",{onClick:()=>y(t.href),className:"text-left w-full hover:text-blue-600",children:t.label||t.id||`Section ${i+1}`}),t.subitems&&t.subitems.length>0&&e.jsx("ul",{className:"pl-4 mt-2",children:t.subitems.map((c,n)=>e.jsx("li",{className:"py-1",children:e.jsx("button",{onClick:()=>y(c.href),className:"text-left w-full text-sm hover:text-blue-600",children:c.label||c.id||`Subsection ${n+1}`})},`${i}-${n}`))})]},i)):e.jsx("li",{className:"py-2 text-gray-500 italic",children:"No table of contents available"})})]})]}),e.jsx("div",{ref:x,className:"flex-grow overflow-hidden relative",style:{height:"calc(100vh - 56px)"}}),e.jsxs("div",{className:"absolute inset-0 top-[56px] flex z-50 pointer-events-none",children:[e.jsx("button",{className:"w-1/3 h-full bg-transparent cursor-pointer hover:bg-black/5 active:bg-black/10 transition-colors focus:outline-none pointer-events-auto",onClick:t=>{t.stopPropagation(),j("prev")},"aria-label":"Previous page"}),e.jsx("div",{className:"w-1/3 h-full"}),e.jsx("button",{className:"w-1/3 h-full bg-transparent cursor-pointer hover:bg-black/5 active:bg-black/10 transition-colors focus:outline-none pointer-events-auto",onClick:t=>{t.stopPropagation(),j("next")},"aria-label":"Next page"})]})]})});export{D as clientAction,W as clientLoader,Z as default,V as meta};
